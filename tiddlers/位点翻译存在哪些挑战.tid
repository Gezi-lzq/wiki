created: 20241007112611920
creator: Gezi-lzq
modified: 20241007133948754
modifier: Gezi-lzq
tags: 梳理MM2位点翻译流程
title: 位点翻译存在哪些挑战

回顾理想情况下位点翻译流程的前提：源集群和目标集群之间的消息复制是一一对应的，也就是说，源集群中的每一个位点都对应着目标集群中的一个位点。

而现实情况下，该前提并不成立！

[img[topic_have_gaps.png]]

!!!''事务标记（Transaction markers）''
在Kafka中，为了支持事务性消息，引入了事务标记。事务标记是一种特殊的消息，它标记了事务的开始和结束。在生产者端，事务标记占用了一个偏移量，但是在消费者端，这些事务标记并不会被消费，也就是说，它们不会被复制到目标集群的对应偏移量。

举例来说，源集群中的偏移量10可能是一个事务标记，虽然它在源集群中占用了一个偏移量，但在目标集群中并没有对应的消息，因为消费者不会消费这个事务标记。这就打破了一一对应的假设。

!!!''SMTs（Single Message Transforms，单消息转换）''
SMTs是Kafka Connect的一个功能，它允许在消息被写入目标主题之前对消息进行转换。一些SMTs可能会选择丢弃某些消息，这些消息将不会被写入目标主题。

例如，我们可能有一个SMT，它的任务是过滤掉所有包含"test"关键字的消息。源集群中偏移量为20的消息包含了"test"关键字，所以这个消息被SMT过滤掉，不会被复制到目标主题。因此，源集群中的偏移量20在目标集群中并没有对应的消息。

!!!''Compacted Topics''
Kafka支持对主题进行压缩，以减少存储空间的使用。当主题被压缩时，一些旧的消息将被删除，只保留每个键的最新消息。这样，源集群中的一些偏移量可能会被删除，而在目标集群中并没有对应的消息。

例如，源集群中的偏移量30的消息已经被删除（因为主题被压缩），只保留了每个键的最新消息。这就意味着，源集群中的偏移量30在目标集群中并没有对应的消息。

!!!''MM2复制落后''
MirrorMaker 2（MM2）是Kafka的一个组件，用于在集群之间复制数据。在某些情况下，MM2可能会落后于源集群的消费者组。这就意味着，源集群中的一些最新的偏移量可能还没有被MM2复制到目标集群。

例如，源集群中的消费者组正在快速地消费消息，而MM2正在尽力地跟上。然而，由于某些原因，MM2落后了，它还没有复制源集群中偏移量为40的消息。这就意味着，源集群中的偏移量40在目标集群中并没有对应的消息。


https://issues.apache.org/jira/browse/KAFKA-12468

!!! ''Data Replication Semantics: At Least Once''
数据复制至少一次意味着数据在源集群和目标集群之间的传输至少会发生一次。这种复制语义保证了数据的可靠性，即使在网络故障或其他异常情况下，也不会丢失数据。具体来说：

优点：确保数据不会丢失，数据的完整性得到保证。
缺点：可能会导致重复数据，因为在某些情况下，同一条数据可能会被复制多次。

但是这就打破了前提，源集群的某个record可能对应该到目标集群的多个offset，不再是一一对应的关系了。